import org.eclipse.emf.mwe.utils.StandaloneSetup
import org.eclipse.emf.mwe2.ecore.EcoreGenerator


final EMF_GEN_DIR = "main/emf-gen"
final MODELS_DIR = "models"
final MODELS = "platform:/resource/org.foam.models/" + MODELS_DIR

defaultTasks 'generateModels'

sourceSets.main.java.srcDir EMF_GEN_DIR

task generateRedirect(type: Exec) {
	workingDir projectDir
	commandLine 'gradle', 'generateModels'
}

// TODO - declare outputs to speed up build
task generateModels {
//	inputs.dir SRC_DIR
//	inputs.dir MODELS_DIR
//	outputs.dir EMF_GEN_DIR
	
	doLast {
		new StandaloneSetup().with {
			scanClassPath = true
			platformUri = ".."
		}
	
		file(EMF_GEN_DIR).deleteDir()
		
		def genmodelNames = file(MODELS_DIR)
			.listFiles()
			.collect{it.name}
			.findAll{it.endsWith(".genmodel")}
	
		// TODO - XTEND_GEN_DIR is passed to the generator but
		// in the time of compilation is XTEND_GEN empty
		for(genmodel in genmodelNames) {
			new EcoreGenerator().with {
				genModel = "${MODELS}/${genmodel}"
				addSrcPath(SRC_DIR)
				addSrcPath(XTEND_GEN_DIR)
				generateEdit = false
				generateEditor = false
				invoke(null)
			}
		}
		
		file("plugin.xml").delete()
		file("plugin.properties").delete()
		
		println "done. don't forget to refresh the workspace"
	}
}

compileXtend.dependsOn('generateRedirect')

clean << {
	file(EMF_GEN_DIR).deleteDir()
}
