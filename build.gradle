// build script is based on http://paulonjava.blogspot.de/2013/11/building-bndtools-projects-with-gradle.html

import aQute.bnd.build.Workspace

defaultTasks 'clean', 'bndbuild'

ext.SRC_DIR 		= "main/src"
ext.XTEND_GEN_DIR 	= "main/xtend-gen"

//Add bnd as a build dependency
buildscript {
	repositories { mavenCentral() }
	dependencies {
		classpath files('cnf/plugins/biz.aQute.bnd/biz.aQute.bnd-2.4.0.jar')
		classpath 'org.xtend:xtend-gradle-plugin:0.1.+'
	}
}

// Setup the workspace
def parentDir = project.projectDir
Workspace workspace = Workspace.getWorkspace(parentDir)

subprojects { p ->
	apply plugin: 'xtend' // applies plugin 'java'

	dependencies {
		compile 'org.eclipse.xtend:org.eclipse.xtend.lib:2.6.+'
	}
	
	repositories { mavenCentral() }
	
	//Setup source and target directories
	sourceCompatibility = 1.7
	targetCompatibility = 1.7

	sourceSets {
		main {
			// TODO - emf-gen
			java.srcDirs = [SRC_DIR, XTEND_GEN_DIR, 'main/emf-gen']
			resources.srcDirs = [SRC_DIR]
			// output.classesDir property is somehow overriden by
			// xtend gradle plugin and classes are always generated into
			// build/classes/main directory. This is probably bug.
//			output.classesDir = BIN_DIR
//			output.resourcesDir = BIN_DIR
			xtendOutputDir = XTEND_GEN_DIR
		}
		
		// TODO
//		test {
//			java.srcDirs = ['test/src', 'test/xtend-gen']
//			resources.srcDirs = ['test/src']
//			output.classesDir = 'test/bin'
//			output.resourcesDir = 'test/bin'
//		}
	}
	testResultsDirName = 'generated/test-reports'
	
	compileXtend.doFirst {
		file(XTEND_GEN_DIR).mkdir()
	}
	
	//Setup project dependencies
	aQute.bnd.build.Project bndProject = workspace.getProject(p.projectDir)
	bndProject.getDependson().each {
		compileXtend.dependsOn(":${it.name}:bndbuild")
	}

	bndProject.getBuildpath().each {
		dependencies.add('compile', files(it.getFile()))
	}

	//Add junit as a default dependency
	dependencies.add('testCompile', 'junit:junit:4.+')

	//Perform the actual bnd build
	task bndbuild << { task ->
		bndProject.build()

		//Report errors and warnings to the Gradle output
		bndProject.getWarnings().each { logger.warn it }

		bndProject.getErrors().each { logger.error it }

		//Fail the build if there are build errors
		if(bndProject.getErrors()) {
			throw new  GradleException("Bnd build failure. Check build logs for error messages")
		}
	}

//	bndbuild.dependsOn([
//		'compileJava',
//		'processResources'
//	])
	bndbuild.dependsOn([
		'build'
	])

	//Run integration tests
	task bndtest << { task ->
		if(bndProject.getProperty("Test-Cases")) {
			bndProject.test();
		}
	}

	clean << {
		['generated', XTEND_GEN_DIR].each {
			p.file(it).deleteDir()
		}
	}
}

// TODO
//Collect generated and external bundles for deployment
task release << {
	delete "release"

	ant.taskdef(name: 'bndrelease', classname: 'aQute.bnd.ant.RunconfigToDistributionTask', classpath: 'cnf/plugins/biz.aQute.bnd/biz.aQute.bnd-2.4.0.jar')
	ant.bndrelease(allowsnapshots: true, bndfile: 'run/webshop.bndrun', rootdir: './', outputdir: 'release')
}

//Generate a Gradle wrapper
task wrapper(type: Wrapper) { gradleVersion = '2.0' }